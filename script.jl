# #2021
# # Who made it to playoffs, and how good are they?
# TEAMS = Dict(
#     1  => (" KC", 1711, (39.048914, -94.484039)),
#     2  => ("BUF", 1682, (42.773739, -78.786978)),
#     3  => ("PIT", 1578, (40.446786, -80.015761)),
#     4  => ("TEN", 1572, (36.166461, -86.771289)),
#     5  => ("BAL", 1651, (39.277969, -76.622767)),
#     6  => ("CLE", 1578, (41.506022, -81.699564)),
#     7  => ("IND", 1594, (39.760056, -86.163806)),
    
#     11 => (" GB", 1675, (44.501306, -88.062167)),
#     12 => (" NO", 1731, (29.950931, -90.081364)),
#     13 => ("SEA", 1620, (47.595153, -122.33162)),
#     14 => ("WSH", 1453, (38.907697, -76.864517)),
#     15 => (" TB", 1618, (27.975967, -82.503350)),
#     16 => ("LAR", 1591, (38.632975, -90.188547)),
#     17 => ("CHI", 1497, (41.862306, -87.616672)),
# )

# # Where is superbowl played?
# SUPERBOWL_LOC = (27.975967, -82.50335)

# # What were the picks people made?
# PICKS = [
#     "Akhil" => [ "TB", "SEA",  "NO", "BAL", "PIT", "BUF",  "GB",  "NO",  "KC", "BUF",  "GB", "BUF", "BUF"],
#     "Steve" => [ "TB", "SEA",  "NO", "TEN", "PIT", "BUF",  "GB",  "NO",  "KC", "BUF",  "GB", "BUF", "BUF"],
#     "Dustin"=> [ "TB", "SEA",  "NO", "BAL", "PIT", "BUF",  "GB",  "NO",  "KC", "BUF",  "NO",  "KC",  "KC"],
#     "Jacob" => [ "TB", "SEA",  "NO", "BAL", "PIT", "BUF",  "GB",  "NO",  "KC", "BUF",  "NO",  "KC",  "KC"],
#     "David" => [ "TB", "LAR",  "NO", "TEN", "PIT", "BUF",  "GB",  "TB",  "KC", "BUF",  "GB", "BUF", "BUF"],
#     "Eric"  => [ "TB", "SEA",  "NO", "BAL", "PIT", "BUF",  "TB",  "NO",  "KC", "BUF",  "NO",  "KC",  "KC"],
#     "Mo"    => [ "TB", "LAR",  "NO", "BAL", "CLE", "BUF",  "GB",  "TB",  "KC", "BUF",  "GB",  "KC",  "KC"],
#     "Ben"   => [ "TB", "SEA",  "NO", "BAL", "PIT", "BUF",  "TB",  "NO", "BAL", "BUF",  "NO", "BUF", "BUF"]
# ]

# # Who has played and won their games already?
# WINS = ["BUF", "LAR", "TB", "BAL", "NO", "CLE", "GB", "BUF", "KC", "TB"]






# #2022
# # Who made it to playoffs, and how good are they?
# TEAMS = Dict(
#     1  => ("TEN", 1590, (36.166461, -86.771289)),
#     2  => ( "KC", 1689, (39.048914, -94.484039)),
#     3  => ("BUF", 1637, (42.773739, -78.786978)),
#     4  => ("CIN", 1570, (39.095442, -84.516039)),
#     5  => ( "LV", 1480, (37.751411,-122.200889)),
#     6  => ( "NE", 1571, (42.090925, -71.264350)),
#     7  => ("PIT", 1486, (40.446786, -80.015761)),

#     11 => ( "GB", 1680, (44.501306, -88.062167)),
#     12 => ( "TB", 1654, (27.975967, -82.503350)),
#     13 => ("DAL", 1636, (32.747778, -97.092778)),
#     14 => ("LAR", 1591, (38.632975, -90.188547)),
#     15 => ("ARI", 1523, (33.527700,-112.262608)),
#     16 => ( "SF", 1580, (37.713486,-122.386256)),
#     17 => ("PHI", 1508, (39.900775, -75.167453)),
# )

# # Where is superbowl played?
# SUPERBOWL_LOC = (38.632975, -90.188547)

# # What were the picks people made?
# PICKS = [
#     ("Akhil" , [ "TB", "SF", "LAR", "KC", "BUF", "CIN",  "GB",  "TB", "TEN",  "KC", "GB", "TEN", "TEN"]),
#     ("Steve" , [ "TB", "SF", "LAR", "KC", "BUF", "CIN",  "GB",  "TB", "CIN", "BUF", "GB", "BUF",  "GB"]),
#     ("Dustin", [ "TB", "SF", "ARI", "KC", "BUF", "CIN",  "GB", "ARI", "TEN",  "KC", "GB",  "KC",  "GB"]),
#     ("Jacob" , [ "TB","DAL", "LAR", "KC", "BUF", "CIN",  "GB",  "TB", "TEN",  "KC", "GB", "TEN",  "GB"]),
#     ("Ben"   , [ "TB","DAL", "LAR", "KC", "BUF", "CIN",  "GB", "DAL", "TEN", "BUF", "GB", "TEN",  "GB"]),
#     ("Eric"  , [ "TB","DAL", "LAR", "KC", "BUF", "CIN",  "GB", "DAL", "CIN", "BUF", "GB", "BUF", "BUF"]),
#     ("Mo"    , [ "TB","DAL", "LAR", "KC",  "NE", "CIN",  "GB",  "TB", "TEN",  "KC", "GB",  "KC",  "KC"]),
#     ("Drew"  , [ "TB","DAL", "ARI", "KC",  "NE",  "LV",  "GB",  "TB",  "NE",  "KC", "TB",  "KC",  "KC"]),
#     ("David" , [ "TB", "SF", "LAR", "KC", "BUF", "CIN",  "GB", "LAR", "TEN", "BUF","LAR", "BUF", "BUF"]),
#     ("Sean"  , [ "TB","DAL", "LAR", "KC", "BUF",  "LV",  "GB",  "TB", "TEN", "BUF", "GB", "TEN",  "GB"]),
#     ("Guim"  , [ "TB", "SF", "LAR", "KC", "BUF", "CIN",  "GB", "LAR", "TEN", "BUF", "GB", "BUF",  "GB"]),
# ]

# # Who has played and won their games already?
# WINS = []


# #2023
# # Who made it to playoffs, and how good are they?
# TEAMS = Dict(
#     1  => ( "KC", 1702,    (39.048914, -94.484039)),
#     2  => ("BUF", 1708,    (42.773739, -78.786978)),
#     3  => ("CIN", 1666,    (39.095442, -84.516039)),
#     4  => ("JAX", 1540,    (30.323674, -81.637328)),
#     5  => ("LAC", 1543,    (33.952815, -118.340306)),
#     6  => ("BAL", 1608-92, (39.277969, -76.622767)),
#     7  => ("MIA", 1509-160, (25.956799, -80.240191)),

#     11 => ("PHI", 1650,    (39.900775, -75.167453)),
#     12 => ( "SF", 1700-80, (37.713486,-122.386256)),
#     13 => ("MIN", 1553,    (44.973805, -93.259297)),
#     14 => ( "TB", 1504,    (27.975967, -82.503350)),
#     15 => ("DAL", 1616,    (32.747778, -97.092778)),
#     16 => ("NYG", 1503,    (40.813303, -74.074500)),
#     17 => ("SEA", 1463,    (47.595153, -122.33162)),
# )

# # Where is superbowl played?
# SUPERBOWL_LOC = (33.525890, -112.261958)

# # What were the picks people made?
# PICKS = [
#     # ("Akhil" , [ "TB", "SF", "LAR", "KC", "BUF", "CIN",  "GB",  "TB", "TEN",  "KC", "GB", "TEN", "TEN"]),
#     # ("Steve" , [ "TB", "SF", "LAR", "KC", "BUF", "CIN",  "GB",  "TB", "CIN", "BUF", "GB", "BUF",  "GB"]),
#     # ("Dustin", [ "TB", "SF", "ARI", "KC", "BUF", "CIN",  "GB", "ARI", "TEN",  "KC", "GB",  "KC",  "GB"]),
#     # ("Jacob" , [ "TB","DAL", "LAR", "KC", "BUF", "CIN",  "GB",  "TB", "TEN",  "KC", "GB", "TEN",  "GB"]),
#     # ("Ben"   , [ "TB","DAL", "LAR", "KC", "BUF", "CIN",  "GB", "DAL", "TEN", "BUF", "GB", "TEN",  "GB"]),
#     # ("Eric"  , [ "TB","DAL", "LAR", "KC", "BUF", "CIN",  "GB", "DAL", "CIN", "BUF", "GB", "BUF", "BUF"]),
#     # ("Mo"    , [ "TB","DAL", "LAR", "KC",  "NE", "CIN",  "GB",  "TB", "TEN",  "KC", "GB",  "KC",  "KC"]),
#     # ("Drew"  , [ "TB","DAL", "ARI", "KC",  "NE",  "LV",  "GB",  "TB",  "NE",  "KC", "TB",  "KC",  "KC"]),
#     # ("David" , [ "TB", "SF", "LAR", "KC", "BUF", "CIN",  "GB", "LAR", "TEN", "BUF","LAR", "BUF", "BUF"]),
#     # ("Sean"  , [ "TB","DAL", "LAR", "KC", "BUF",  "LV",  "GB",  "TB", "TEN", "BUF", "GB", "TEN",  "GB"]),
#     # ("Guim"  , [ "TB", "SF", "LAR", "KC", "BUF", "CIN",  "GB", "LAR", "TEN", "BUF", "GB", "BUF",  "GB"]),
# ]

# # Who has played and won their games already?
# WINS = []



# #2024
# # Who made it to playoffs, and how good are they?
# TEAMS = Dict(
#     1  => ("BAL", 1610,    (39.277969, -76.622767)),#1704 1529
#     2  => ("BUF", 1697,    (42.773739, -78.786978)),#1679 1697
#     3  => ( "KC", 1615,    (39.048914, -94.484039)),#1621 1615
#     4  => ("HOU", 1492,    (29.684456, -95.410729)),#1479 1492
#     5  => ("CLE", 1512,    (41.505885, -81.699773)),#1537 1512
#     6  => ("MIA", 1611,    (25.956799, -80.240191)),#1574 1611
#     7  => ("PIT", 1552,    (40.444805, -80.016026)),#1563 1552
 
#     11 => ( "SF", 1631,    (37.713486,-122.386256)),#1704 1631
#     12 => ("DAL", 1691,    (32.747778, -97.092778)),#1650 1691
#     13 => ("DET", 1607,    (42.338809, -83.044423)),#1594 1607
#     14 => ( "TB", 1436,    (27.975967, -82.503350)),#1519 1436
#     15 => ("PHI", 1546,    (39.900775, -75.167453)),#1554 1546
#     16 => ("LAR", 1571,    (38.632975, -90.188547)),#1536 1571
#     17 => ( "GB", 1519,    (44.501306, -88.062167)),#1554 1519
# )

# # Where is superbowl played?
# SUPERBOWL_LOC = (36.089271, -115.182872)


# # What were the picks people made?
# PICKS = [
#     ("Akhil", ["DAL", "LAR",  "TB", "BUF",  "KC", "CLE", "LAR", "DAL", "BUF", "BAL", "DAL", "BAL", "BAL"]),
#     ("Steve", ["DAL", "LAR", "PHI", "BUF", "MIA", "CLE",  "SF", "DAL", "CLE", "BAL", "DAL", "BAL", "DAL"]),
#     ("David", [ "GB", "DET", "PHI", "BUF",  "KC", "CLE", "DET",  "GB", "BUF", "BAL", "DET", "BUF", "BUF"]),
#     ("Jacob", ["DAL", "DET", "PHI", "BUF",  "KC", "CLE",  "SF", "DAL", "BUF", "BAL",  "SF", "BAL",  "SF"]),
#     ("Ben",   ["DAL", "DET",  "TB", "BUF",  "KC", "HOU",  "SF", "DET", "BUF", "BAL",  "SF", "BAL", "BAL"]),
#     ("Dustin",["DAL", "LAR",  "TB", "BUF",  "KC", "HOU",  "SF", "DAL", "BUF", "BAL",  "SF", "BUF",  "SF"]),
#     ("Erin",  ["DAL", "DET", "PHI", "BUF", "MIA", "HOU",  "SF", "DET", "BUF", "BAL", "DET", "BAL", "BAL"]),
#     ("Sean",  ["DAL", "LAR",  "TB", "BUF",  "KC", "CLE",  "SF", "DAL",  "KC", "BAL", "DAL",  "KC", "DAL"]),
#     ("Guim",  ["DAL", "LAR",  "TB", "BUF",  "KC", "CLE",  "SF", "DAL",  "KC", "BAL",  "SF", "BAL",  "SF"]),
#     ("Mo",    ["DAL", "LAR",  "TB", "BUF",  "KC", "CLE",  "SF", "DAL",  "KC", "BAL",  "SF",  "KC",  "KC"]),
#     ("Eric",  ["DAL", "LAR",  "TB", "BUF", "MIA", "CLE",  "SF", "DAL", "BUF", "BAL", "DAL", "BAL", "DAL"]),
#     ("Annie*",["DAL", "DET", "PHI", "BUF", "MIA", "HOU", "PHI", "DET", "BUF", "MIA", "DET", "MIA", "MIA"]),
# ]



#2025
# Who made it to playoffs, and how good are they?
TEAMS = Dict(
    1  => ( "KC", 1582,    (39.048914, -94.484039)),
    2  => ("BUF", 1576,    (42.773739, -78.786978)),
    3  => ("BAL", 1609,    (39.277969, -76.622767)),
    4  => ("HOU", 1502,    (29.684456, -95.410729)),
    5  => ("LAC", 1539,    (33.952815, -118.34030)),
    6  => ("PIT", 1507,    (40.444805, -80.016026)),
    7  => ("DEN", 1563,    (39.743550, -105.02014)),

    11 => ("DET", 1613,    (42.338809, -83.044423)),
    12 => ("PHI", 1570,    (39.900775, -75.167453)),
    13 => ( "TB", 1557,    (27.975967, -82.503350)),
    14 => ("LAR", 1509,    (38.632975, -90.188547)),
    15 => ("MIN", 1546,    (44.973805, -93.259297)),
    16 => ("WSH", 1514,    (38.907697, -76.864517)),
    17 => ( "GB", 1565,    (44.501306, -88.062167)),
)


# Where is superbowl played?
SUPERBOWL_LOC = (29.950875054342415, -90.08093306693422)


# What were the picks people made?
PICKS = [
    ("Akhil",   ["PHI",  "TB", "LAR", "BUF", "BAL", "LAC", "PHI", "DET", "BAL",  "KC", "PHI",  "KC",  "KC"]),
    ("Steve",   [ "GB",  "TB", "MIN", "DEN", "BAL", "LAC",  "TB", "DET", "LAC",  "KC", "DET",  "KC", "DET"]),
    ("David",   ["PHI", "WSH", "MIN", "BUF", "BAL", "LAC", "WSH", "MIN", "BUF", "LAC", "WSH", "BUF", "BUF"]),
    ("Jacob",   ["PHI", "WSH", "MIN", "BUF", "BAL", "LAC", "MIN", "DET", "BAL", "LAC", "DET", "BAL", "DET"]),
    ("Ben",     ["PHI",  "TB", "MIN", "BUF", "BAL", "LAC", "PHI", "DET", "BAL", "LAC", "PHI", "BAL", "PHI"]),
    ("Dustin",  ["PHI", "WSH", "LAR", "BUF", "BAL", "HOU", "PHI", "DET", "BAL",  "KC", "PHI", "BAL", "BAL"]),
    ("Erin",    ["PHI",  "TB", "MIN", "BUF", "BAL", "LAC", "PHI", "DET", "BUF",  "KC", "DET", "BUF", "BUF"]),
    ("Sean",    ["PHI", "WSH", "MIN", "BUF", "BAL", "LAC", "PHI", "DET", "BUF",  "KC", "DET", "BUF", "BUF"]),
    ("Annie",   ["PHI", "WSH", "LAR", "BUF", "BAL", "HOU", "LAR", "DET", "BAL",  "KC", "DET",  "KC", "DET"]),
    ("Mo",      ["PHI", "WSH", "MIN", "BUF", "BAL", "HOU", "MIN", "DET", "BUF",  "KC", "DET",  "KC",  "KC"]),
    ("Bens_Dad",["PHI", "WSH", "MIN", "BUF", "BAL", "LAC", "PHI", "DET", "BUF",  "KC", "DET", "BUF", "DET"]),
    ("Eleanor", [ "GB",  "TB", "LAR", "BUF", "BAL", "LAC", "LAR", "DET", "BAL", "LAC", "DET", "LAC", "DET"]),
    ("Eric",    ["PHI",  "TB", "LAR", "BUF", "BAL", "LAC", "PHI", "LAR", "BAL",  "KC", "PHI", "BAL", "BAL"]),
]


# Who has played and won their games already?
WINS = []

#### END INPUT ####
using StatsBase
using DelimitedFiles
using Distributions
using JSON

function winner(game_i, round, T)
    while true
        n_i = game_i ÷ 2
        if n_i < 2^round
            if iseven(game_i)
                return(T[n_i][1])
            else
                return(T[n_i][2])
            end
        end
        game_i = n_i
    end
end

function get_teams(game_i, T)
    if     game_i < 2^1
        # return (2,7)
        return (4,5)
        # return (12,17)

    elseif game_i < 2^2
        # return (13,16)
        return (3,6)
        # return (4,5)

    elseif game_i < 2^3
        # return (14,15)
        # return (12,17)
        # return (12,17)
        return (2,7)

    elseif game_i < 2^4
        # return (4,5)
        # return (13,16)
        # return (13,16)
        return (12,17)

    elseif game_i < 2^5
        # return (12,17)
        # return (2,7)
        return (13,16)

    elseif game_i < 2^6
        # return (3,6)
        # return (14,15)
        return (14,15)

    elseif game_i < 2^7
        # opp = maximum([winner(game_i,rnd,T) for rnd in [2,3,5]])
        # return (11,opp)
        # opp = maximum([winner(game_i,rnd,T) for rnd in [1,2,5]])
        # return (1,opp)
        opp = maximum([winner(game_i,rnd,T) for rnd in [1,2,3]])
        return (1,opp)
        
    elseif game_i < 2^8
        # tms = sort([winner(game_i,rnd,T) for rnd in [1,4,6]])
        # return (tms[1],tms[2])
        # opp = maximum([winner(game_i,rnd,T) for rnd in [3,4,6]])
        # return (11,opp)
        opp = maximum([winner(game_i,rnd,T) for rnd in [4,5,6]])
        return (11,opp)

    elseif game_i < 2^9
        # opp = maximum([winner(game_i,rnd,T) for rnd in [1,4,6]])
        # return (1,opp)
        # tms = sort([winner(game_i,rnd,T) for rnd in [3,4,6]])
        # return (tms[1],tms[2])
        tms = sort([winner(game_i,rnd,T) for rnd in [4,5,6]])
        return (tms[1],tms[2])
    
    elseif game_i < 2^10
        # tms = sort([winner(game_i,rnd,T) for rnd in [2,3,5]])
        # return (tms[1],tms[2])
        # tms = sort([winner(game_i,rnd,T) for rnd in [1,2,5]])
        # return (tms[1],tms[2])
        tms = sort([winner(game_i,rnd,T) for rnd in [1,2,3]])
        return (tms[1],tms[2])

    elseif game_i < 2^11
        # tms = sort([winner(game_i,rnd,T) for rnd in [8,9]])
        # return (tms[1],tms[2])
        # tms = sort([winner(game_i,rnd,T) for rnd in [7,10]])
        # return (tms[1],tms[2])
        tms = sort([winner(game_i,rnd,T) for rnd in [8,9]])
        return (tms[1],tms[2])

    elseif game_i < 2^12
        # tms = sort([winner(game_i,rnd,T) for rnd in [7,10]])
        # return (tms[1],tms[2])
        # tms = sort([winner(game_i,rnd,T) for rnd in [8,9]])
        # return (tms[1],tms[2])
        tms = sort([winner(game_i,rnd,T) for rnd in [7,10]])
        return (tms[1],tms[2])

    elseif game_i < 2^13
        return (winner(game_i,11,T), winner(game_i,12,T))
    end
end

function get_playoff_structure()
    teams = Tuple{Int,Int}[]
    teams = [get_teams(i, teams) for i in 2^0:2^6-1]           #wc
    append!(teams, [get_teams(i, teams) for i in 2^6:2^10-1])  #conf
    append!(teams, [get_teams(i, teams) for i in 2^10:2^12-1]) #div
    append!(teams, [get_teams(i, teams) for i in 2^12:2^13-1]) #sb

    teams
end
PLAYOFFS = get_playoff_structure()


function get_lr(idx)
    n = idx + 8191
    c = falses(13)
    i = 13
    while n > 1
        if iseven(n)
            c[i] = true
            n = n/2
        else
            n = (n-1)/2
        end
        i-=1
    end
    c
end

hav(θ) = (1.0-cos(θ))/2.0
function dist(l1, l2; r=3960.0)
    ϕ1 = deg2rad(l1[1])
    ϕ2 = deg2rad(l2[1])
    λ1 = deg2rad(l1[2])
    λ2 = deg2rad(l2[2])

    2r * asin(sqrt(hav(ϕ2-ϕ1) + cos(ϕ1)*cos(ϕ2)*hav(λ2-λ1)))
end
#dist((32.322, -116.973), (44.869, -68.369)) #should be ~2719

```
Get winner predicted by difference in ELO according to https://fivethirtyeight.com/methodology/how-our-nfl-predictions-work/
```
function get_game_prob(t1, t2, wk)
    HOME_ADV = 48 #was 55 previously
    REST_ADV = 25
    PLAYOFF_MULT = 1.2

    t1_elo, t1_loc = TEAMS[t1][2:3]
    t2_elo, t2_loc = TEAMS[t2][2:3]

    if wk < 4
        l = t1_loc
    else
        l = SUPERBOWL_LOC
    end

    Δelo_travel = 4/1000 * (dist(l, t2_loc) - dist(l, t1_loc))

    if (wk==1) || (wk==2 && t1≠1 && t2≠11) || (wk==3) #Regular playoff games
        Δelo_home = HOME_ADV
        Δelo_mult = PLAYOFF_MULT
        Δelo_rest = 0
    elseif wk == 2 #Rest games for 1 seeds
        Δelo_home = HOME_ADV
        Δelo_mult = PLAYOFF_MULT
        Δelo_rest = REST_ADV
    elseif wk == 4 #Superbowl
        Δelo_mult = PLAYOFF_MULT
        Δelo_home = 0
        Δelo_rest = 0
    end

    elo_diff = Δelo_mult * (t1_elo - t2_elo + Δelo_home + Δelo_travel + Δelo_rest)

    pw_t1 = 1.0 / (1 + 10^(-elo_diff/400))

    pw_t1

end
# get_game_prob(1, 2, 4)

function get_week(i)
    if     i < 2^6
        wk = 1
    elseif i < 2^10
        wk = 2
    elseif i < 2^12
        wk = 3
    elseif i < 2^13
        wk = 4
    end
    wk
end

function get_prob(t1t2, i)
    get_game_prob(t1t2[1], t1t2[2], get_week(i))
end

GAME_PROBS = get_prob.(PLAYOFFS, 1:8191)

function write_game_probs()
    D = Dict()
    val = [[Int(PLAYOFFS[i][1]), PLAYOFFS[i][2], GAME_PROBS[i]] for i in 1:8191]
    D["dat"] = val

    open("game_probs.json", "w") do io
        JSON.print(io, D)
    end
end
write_game_probs()

function get_branch(lr)
    b = zeros(Int,13)
    i = 1
    n = 1
    while i <= 13
        b[i] = n
        if lr[i]
            n = n*2
        else
            n = n*2+1
        end
        i += 1
    end
    b
end

function get_branch_num(lr)
    i = 1
    n = 1
    while i <= 13
        if lr[i]
            n = n*2
        else
            n = n*2+1
        end
        i += 1
    end
    n - (2^13 - 1)
end

function get_outcome_prob(i)
    lr_index = get_lr(i)
    branch = get_branch(lr_index)

    p = 1.0
    for (g,lr) in zip(branch,lr_index)
        pw_t1 = GAME_PROBS[g]
        if lr
            p = p * pw_t1
        else
            p = p * (1.0 - pw_t1)
        end
    end
    p
end

OUTCOME_PROBS = get_outcome_prob.(1:8192)
sum(OUTCOME_PROBS)

# using Plots
# histogram(log10.(OUTCOME_PROBS), 
#     legend=false,
#     xlabel="log(outcome probability)",
#     ylabel="counts", xticks=-10:1:0)
# savefig("outcome_probs.svg")


function get_winners(i)
    lr_index = get_lr(i)
    branch = get_branch(lr_index)
    winners = zeros(Int,13)

    for (i,g,lr) in zip(1:13,branch,lr_index)
        if lr
            winners[i] = PLAYOFFS[g][1]
        else
            winners[i] = PLAYOFFS[g][2]
        end
    end
    winners
end

BRANCH_WINNERS = get_winners.(1:8192)

function get_sb_prob(i)
    branches = Int[]
    for j=1:8192
        if BRANCH_WINNERS[j][end] == i
            push!(branches, j)
        end
    end
    prob = 0.0
    for b in branches
        prob += OUTCOME_PROBS[b]
    end
    prob
end

function print_sb_probs()
    for i in [1:7; 11:17]
        p = get_sb_prob(i)
        println(TEAMS[i][1], " \t", round(p*100,digits=2), "%") 
    end    
end
print_sb_probs()

function count_same(v1,v2)
    count = 0
    for a=v1
        for b=v2
            if a==b 
                count += 1
                break
            end
        end
    end
    count
end

function get_score(pick,real)
    score = 0
    score += 1 * count_same(real[1:6],  pick[1:6])
    score += 2 * count_same(real[7:10], pick[7:10])
    score += 4 * count_same(real[11:12],pick[11:12])
    score += 8 * count_same(real[13:13],pick[13:13])
    
    score
end

function get_score_mat()
    if false #isfile("score_matrix.csv")
        score_mat = readdlm("score_matrix.csv", ',', Int)
    else
        score_mat = zeros(Int, 2^13, 2^13)
        for i = 1:2^13
            println(i)
            picks = get_winners(i)
            Threads.@threads for j = 1:2^13
                reals = get_winners(j)
                score = get_score(picks, reals)
                score_mat[i,j] = score
            end
        end
    end
    score_mat
end

SCORE_MAT = get_score_mat()
# writedlm( "score_matrix.csv",  SCORE_MAT, ",")

dat = Dict()
V = []
for i in 1:8192
    push!(V, SCORE_MAT[i, i:8192])
end
dat["dat"] = V
# dat["dat"] = [i for i in eachrow(SCORE_MAT)]
# write dat to file
open("score_matrix_tri.json", "w") do io
    JSON.print(io, dat)
end




# Get likelihood of outcomes given starting at game i - return a 2^13 vector with all outcomes (many of which may be 0)
function get_pos_outcomes(i)
    lb = 2*i
    ub = 2*i+1
    while lb < 2^13
        lb = 2*lb
        ub = 2*ub+1
    end
    lb = lb - (2^13-1)
    ub = ub - (2^13-1)

    lb, ub
end

function lower_outcome_probs(i)
    lb, ub = get_pos_outcomes(i)
    
    p_out = zeros(Float64, 2^13)
    p_out[lb:ub] = OUTCOME_PROBS[lb:ub]./sum(OUTCOME_PROBS[lb:ub])

    p_out
end

REVERSE_DIC = Dict{String,Int}()
for (k,v) in TEAMS
    REVERSE_DIC[v[1]] = k
end
function get_pick_branch(pick)
    picks = sort([REVERSE_DIC[p] for p in pick])

    for i in 1:2^13
        b = sort(get_winners(i))
        if b == picks
            return i
        end
    end
    return 0
end


PICK_NUMS = [get_pick_branch(p[2]) for p in PICKS]
function get_everyones_prob(i)
    lb, ub = get_pos_outcomes(i)
    outcome_probs = lower_outcome_probs(i)
    
    e_prob = zeros(length(PICK_NUMS))
    for o in lb:ub
        scores = [SCORE_MAT[p,o] for p in PICK_NUMS]
        winners = findall(scores .== maximum(scores))
        e_prob[winners] .+= outcome_probs[o]/length(winners)
    end

    e_prob
end

get_everyones_prob(1)


## Make vis JSON dict to read in
function make_big_dic()
    BIG_DIC = Dict()
    BIG_DIC["names"] = [p[1] for p in PICKS]

    main_text_dict = Dict()
    for (i,g) in enumerate(PLAYOFFS)
        main_text_dict[i] = (TEAMS[g[1]][1], TEAMS[g[2]][1])
    end
    BIG_DIC["main"] = main_text_dict

    left_text_dict = Dict()
    for (i,g) in enumerate(GAME_PROBS)
        left_text_dict[i] = g[1]
    end
    BIG_DIC["left"] = left_text_dict

    right_text_dict = Dict()
    for i in 1:2^13-1
        all_probs = get_everyones_prob(i)
        right_text_dict[i] = all_probs
    end
    BIG_DIC["right"] = right_text_dict

    scores_dic = Dict()
    for i in 1:2^13
        scores = [SCORE_MAT[p,i] for p in PICK_NUMS]
        scores_dic[i] = scores
    end
    BIG_DIC["scores"] = scores_dic

    BIG_DIC["picks"] = PICKS

    BIG_DIC
end

BIG_DIC = make_big_dic()
# write the file with the stringdata variable information
open("big_dic.json", "w") do f
    write(f, JSON.json(BIG_DIC))
end

# read_back = JSON.parsefile("test.json")


